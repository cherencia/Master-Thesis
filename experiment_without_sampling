
-- Last log for counting services
 WITH last_log AS
  (SELECT user_id,
          max(logtime) AS logtime_lastLog
   FROM oneapp_data.oa_events
   WHERE event_action = 'USER_ATTRIBUTE'
     AND ua_key IN ('Count of Mobile Services',
                    'Count of Fixed TV Services',
                    'Count of Fixed Internet Services',
                    'Count of Fixed Voice Services')
     AND extract(MONTH
                 FROM date) IN (10,
                                11)
   GROUP BY user_id), -- Main table, containing every payment and descriptive data
 payment_info AS
  (SELECT user_id,
          attr_instrument_str,
          attr_price_num,
          attr_category_str,
          attr_label_str,
          ATTR_method_STR,
          appVersion,
          connectionType,
          deviceModel,
          logtime,
          event_action,
          attr_os_str,
          devicebrand,
          nc
   FROM oneapp_data.oa_events
   WHERE event_action = 'Payment Completed'), -- Count of times the customer clicks on the Campaign
 cnt_cta AS
  (SELECT user_id,
          count(event_action) AS cnt_call
   FROM oneapp_data.oa_events
   WHERE event_action = 'Overview Campaign CTA'
     AND YEAR = 2020
   GROUP BY user_id), -- Count of times the customer visulizes a campaign
 cnt_displayed AS
  (SELECT user_id,
          count(event_action) AS cnt_dis
   FROM oneapp_data.oa_events
   WHERE event_action = 'Overview Campaign Displayed'
     AND YEAR = 2020
   GROUP BY user_id), -- Count of number mobile services a customer has
 cnt_mobile_services AS
  (SELECT x.user_id,
          x.UA_VALUE_NUM AS cnt_mobile
   FROM oneapp_data.oa_events x
   INNER JOIN last_log y ON x.user_id=y.user_id
   AND x.logtime=y.logtime_lastLog
   AND x.event_action= 'USER_ATTRIBUTE'
   AND x.ua_key='Count of Mobile Services'
   AND x.YEAR=2020
   AND extract(MONTH
               FROM x.date) IN (10,
                                11)), -- Count of number of internet services
cnt_internet_services AS
  (SELECT x.user_id,
          x.UA_VALUE_NUM AS cnt_internet
   FROM oneapp_data.oa_events x
   INNER JOIN last_log y ON x.user_id=y.user_id
   AND x.logtime=y.logtime_lastLog
   AND x.event_action= 'USER_ATTRIBUTE'
   AND x.ua_key='Count of Fixed Internet Services'
   AND x.YEAR=2020
   AND extract(MONTH
               FROM x.date) IN (10,
                                11)), -- Count of number of TV services
cnt_TV_services AS
  (SELECT x.user_id,
          x.UA_VALUE_NUM AS cnt_TV
   FROM oneapp_data.oa_events x
   INNER JOIN last_log y ON x.user_id=y.user_id
   AND x.logtime=y.logtime_lastLog
   AND x.event_action= 'USER_ATTRIBUTE'
   AND x.ua_key='Count of Fixed TV Services'
   AND x.YEAR=2020
   AND extract(MONTH
               FROM x.date) IN (10,
                                11)), -- Count of number of TV services
cnt_voice_services AS
  (SELECT x.user_id,
          x.UA_VALUE_NUM AS cnt_voice
   FROM oneapp_data.oa_events x
   INNER JOIN last_log y ON x.user_id=y.user_id
   AND x.logtime=y.logtime_lastLog
   AND x.event_action= 'USER_ATTRIBUTE'
   AND x.ua_key='Count of Fixed Voice Services'
   AND x.YEAR=2020
   AND extract(MONTH
               FROM x.date) IN (10,
                                11))
SELECT a.user_id,
       a.attr_instrument_str,
       a.attr_price_num,
       a.attr_category_str,
       a.attr_label_str,
       a.ATTR_method_STR,
       a.appVersion,
       a.connectionType,
       a.deviceModel,
       a.logtime,
       a.event_action,
       a.attr_os_str,
       a.devicebrand,
       a.nc,
       b.cnt_dis,
       c.cnt_call,
       d.cnt_mobile,
       e.cnt_internet,
       f.cnt_TV,
       g.cnt_voice
FROM payment_info a
LEFT JOIN cnt_displayed b ON a.user_id=b.user_id
LEFT JOIN cnt_cta c ON a.user_id=c.user_id
LEFT JOIN cnt_mobile_services d ON a.user_id=d.user_id
LEFT JOIN cnt_internet_services e ON a.user_id=e.user_id
LEFT JOIN cnt_TV_services f ON a.user_id=f.user_id
LEFT JOIN cnt_voice_services g ON a.user_id=g.user_id
