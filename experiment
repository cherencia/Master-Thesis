-- Sample 100000 customers randomly that were active in October and November
WITH sample_customers AS
  (SELECT DISTINCT user_id
   FROM oneapp_data.oa_events tablesample bernoulli (0.03)
   WHERE YEAR = 2020
     AND extract(MONTH
                 FROM date) IN (10,
                                11)
     AND user_id IS NOT NULL
     AND user_id <> ''
     AND lower(environment) IN ('live',
                                'release')
     AND event_action = 'USER_ATTRIBUTE'
     AND ua_key IN ('Count of Mobile Services',
                    'Count of Fixed TV Services',
                    'Count of Fixed Internet Services',
                    'Count of Fixed Voice Services')
   ),
   -- Last log for counting services
   last_log as (
     select user_id, max(logtime) AS logtime_lastLog
     from oneapp_data.oa_events
     where user_id in (select user_id
     from sample_customers)
     AND event_action = 'USER_ATTRIBUTE'
     AND ua_key IN ('Count of Mobile Services',
                    'Count of Fixed TV Services',
                    'Count of Fixed Internet Services',
                    'Count of Fixed Voice Services')
     AND extract(MONTH FROM date) IN (10,11)

    GROUP BY user_id

  ),

   -- Count of number services a customer has
     cnt_mobile AS
  (SELECT x.user_id,
          x.UA_VALUE_NUM AS cnt_mobile_services
   FROM oneapp_data.oa_events x
   INNER JOIN last_log y on x.user_id=y.user_id and x.logtime=y.logtime_lastLog
     AND x.ua_key='Count of Mobile Services'
     AND x.YEAR=2020
     AND extract(MONTH
                 FROM x.date) IN (10,
                                11)

     )

     select a.user_id,
     b.cnt_mobile_services
     from sample_customers a
     INNER JOIN cnt_mobile b on a.user_id=b.user_id
LIMIT 100
